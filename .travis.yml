if: (branch = master) OR (type = pull_request) OR (tag IS present)

language: rust
rust:
  - stable
  - beta
  - nightly
env:
  global:
    - SCCACHE_VERSION=0.2.12
    - SCCACHE=$HOME/.sccache/bin/sccache
    - RUSTC_WRAPPER=$SCCACHE

jobs:
  allow_failures:
    - rust: nightly
  fast_finish: true
  include:
    - name: "Rust: stable - Examples"
      language: rust
      rust: stable
      services:
        - docker
      install:
        - (cd examples/truffle; yarn install)
        - docker pull trufflesuite/ganache-cli:v6.7.0
      script:
        - (cd examples/truffle; yarn run build)
        - docker run -d -p 9545:8545 trufflesuite/ganache-cli:v6.7.0
        - cargo run --example async
        - cargo run --example linked
        - cargo run --package examples-generate
        - cargo run --example rinkeby

cache:
  directories:
    - $HOME/.cache/sccache
    - $HOME/.cache/yarn
    - $HOME/.cargo
    - $HOME/.rustup
    - examples/truffle/node_modules

before_install:
  - rustup component add clippy rustfmt
  - cargo clippy --version
  - cargo fmt --version
  - |
    mkdir -p $HOME/.sccache/bin
    pushd $HOME/.sccache
    curl -LO https://github.com/mozilla/sccache/releases/download/$SCCACHE_VERSION/sccache-$SCCACHE_VERSION-x86_64-unknown-linux-musl.tar.gz
    tar -C bin -xvf sccache-$SCCACHE_VERSION-x86_64-unknown-linux-musl.tar.gz --wildcards '*/sccache' --strip 1
    popd
  - $SCCACHE --version
  - nvm install stable && nvm alias default stable
  - node --version
  - npm install -g yarn@latest
  - yarn --version

install:
  - (cd examples/truffle; yarn install)

script:
  - (cd examples/truffle; yarn run build)
  - cargo build --all-features --verbose --all
  - cargo test --all-features --verbose --all
  - cargo fmt --all -- --check
  - cargo clippy --all --all-features --all-targets -- -D warnings

before_cache:
  - rm -rf "$TRAVIS_HOME/.cargo/registry"

deploy:
  provider: script
  script: bash ci/deploy.sh
  on:
    tags: true
